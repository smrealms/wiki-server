version: '3.7'

networks:
  frontend:
      name: frontend
      external: false
  backend:
      name: backend
      external: false

services:
    wiki:
        image: requarks/wiki
        restart: unless-stopped
        container_name: smr-wiki
        networks:
            - frontend
            - backend
        environment:
            SESSION_SECRET: ${SESSION_SECRET}
            WIKI_ADMIN_EMAIL: ${WIKI_ADMIN_EMAIL}
            HOST: ${HOST}
            FACEBOOK_APP_ID: ${FACEBOOK_APP_ID}
            FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET}
            GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
            GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
        volumes:
            - ./config.yml:/var/wiki/config.yml:ro
            - ./wiki-data.pem:/github.pem
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=frontend"
            - "traefik.backend=wiki"
            - "traefik.port=80"
            - "traefik.frontend.rule=Host:wiki.smrealms.de"
        depends_on:
            - wiki-db

    wiki-db:
        image: mongo:3
        restart: unless-stopped
        networks:
            - backend
        labels:
            - "traefik.enable=false"
        volumes:
            - ./db:/data/db
